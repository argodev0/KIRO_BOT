# Production Security Configuration for Paper Trading Bot
# Enhanced security headers and configurations for production deployment

# Security headers configuration
add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
add_header X-Frame-Options "DENY" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()" always;

# Content Security Policy for Paper Trading Bot
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' 
        https://unpkg.com 
        https://cdn.jsdelivr.net 
        https://s3.tradingview.com 
        https://charting-library.tradingview.com;
    style-src 'self' 'unsafe-inline' 
        https://fonts.googleapis.com 
        https://cdn.jsdelivr.net;
    img-src 'self' data: https: blob:;
    connect-src 'self' 
        ws: wss: 
        https://api.binance.com 
        https://api.kucoin.com 
        https://stream.binance.com 
        https://ws-api.kucoin.com;
    font-src 'self' 
        https://fonts.gstatic.com 
        https://cdn.jsdelivr.net;
    frame-src 'self' 
        https://www.tradingview.com 
        https://s.tradingview.com;
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
" always;

# Paper Trading Environment Headers - CRITICAL SAFETY
add_header X-Paper-Trading-Mode "true" always;
add_header X-Trading-Environment "PAPER_TRADING_PRODUCTION" always;
add_header X-Real-Trading-Status "DISABLED" always;
add_header X-Financial-Risk "ZERO" always;

# Server identification headers
add_header X-Server-Type "nginx" always;
add_header X-Application "KIRO-Trading-Bot" always;
add_header X-Version "1.0.0" always;

# Rate limiting configuration
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=trading:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=websocket:10m rate=30r/s;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;

# Request size limits
client_max_body_size 10M;
client_body_buffer_size 128k;
client_header_buffer_size 1k;
large_client_header_buffers 4 4k;

# Timeout configurations
client_body_timeout 12;
client_header_timeout 12;
keepalive_timeout 15;
send_timeout 10;

# Hide server information
server_tokens off;
more_clear_headers Server;
more_set_headers "Server: KIRO-Bot";

# SSL Security Configuration
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
ssl_prefer_server_ciphers off;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# OCSP Stapling
ssl_stapling on;
ssl_stapling_verify on;
ssl_trusted_certificate /etc/letsencrypt/live/${DOMAIN_NAME}/chain.pem;
resolver 8.8.8.8 8.8.4.4 valid=300s;
resolver_timeout 5s;

# DH Parameters for enhanced security
ssl_dhparam /etc/nginx/ssl/dhparam.pem;

# Security-focused location blocks
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

location ~ ~$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Deny access to sensitive files
location ~* \.(conf|config|ini|env|log|bak|backup|old|tmp|temp)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Deny access to version control
location ~ /\.(git|svn|hg|bzr) {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Deny access to common attack vectors
location ~* \.(php|asp|aspx|jsp|cgi|pl|py)$ {
    deny all;
    access_log off;
    log_not_found off;
    return 404;
}

# Block common exploit attempts
location ~* (eval\(|base64_decode|gzinflate|rot13|str_rot13) {
    deny all;
    access_log off;
    log_not_found off;
    return 403;
}

# Block SQL injection attempts
location ~* (union.*select|insert.*into|delete.*from|drop.*table) {
    deny all;
    access_log /var/log/nginx/security_violations.log;
    return 403;
}

# Block XSS attempts
location ~* (<script|javascript:|vbscript:|onload=|onerror=) {
    deny all;
    access_log /var/log/nginx/security_violations.log;
    return 403;
}

# Geo-blocking (example - customize as needed)
# geo $blocked_country {
#     default 0;
#     CN 1;  # Block China
#     RU 1;  # Block Russia
# }
# 
# if ($blocked_country) {
#     return 403;
# }

# User agent blocking for known bad bots
map $http_user_agent $blocked_agent {
    default 0;
    ~*malicious 1;
    ~*bot 1;
    ~*crawler 1;
    ~*spider 1;
    "" 1;  # Block empty user agents
}

if ($blocked_agent) {
    access_log /var/log/nginx/blocked_agents.log;
    return 403;
}

# Request method filtering
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$ ) {
    return 405;
}

# Referrer spam protection
map $http_referer $blocked_referer {
    default 0;
    ~*spam-site\.com 1;
    ~*malicious-site\.org 1;
}

if ($blocked_referer) {
    access_log /var/log/nginx/blocked_referers.log;
    return 403;
}

# Additional security measures for production
location /admin {
    # Restrict admin access to specific IPs
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    
    # Additional authentication required
    auth_basic "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;
}

# Security monitoring endpoint (internal only)
location /security/status {
    allow 127.0.0.1;
    allow 172.20.0.0/16;  # Docker network
    deny all;
    
    access_log off;
    return 200 "Security monitoring active\n";
    add_header Content-Type text/plain;
}

# Fail2ban integration log format
log_format security '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'blocked_agent=$blocked_agent '
                   'blocked_referer=$blocked_referer '
                   'request_time=$request_time';